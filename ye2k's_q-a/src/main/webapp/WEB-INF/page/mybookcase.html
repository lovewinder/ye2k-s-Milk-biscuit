<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="./css/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="./lib/bootstrap-validator/css/bootstrapValidator.min.css">
  <title>MyBookCase</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      list-style: none;
    }

    i {
      display: inline-block;
    }

    a,
    a:visited,
    a:hover {
      text-decoration: none;
      color: white;
    }

    .aslid-mbd {
      width: 20%;
      background-color: #000;
      overflow: auto;
    }

    .main-mbd {
      width: 80%;
      background-color: #ccc;
      position: absolute;
      left: 20%;
      top: 0;
      padding: 5% 7%;
    }

    .home-mbd {
      position: relative;
      height: 10%;
    }

    .home-mbd a {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .hp {
      text-align: center;
    }

    .hp img {
      width: 80%;
      border-radius: 50%;
    }

    .currentname {
      color: white;
      margin-top: 5%;
    }

    .sorts {
      color: white;
    }

    .sorts .first {
      position: relative;
      left: -5%;
      margin-top: 20%;
      text-align: center;
    }

    .sorts .first li {
      margin: 15% 0;
    }

    .sorts .second {
      font-size: 12px;
      text-align: left;
      padding-left: 15%;
    }

    .sorts .second li {
      display: none;
    }

    .main-mbd-ul li{
      margin: 5% 0;
    }

    .chapter i{
      color:orange;
      display: inline-block;
      margin-right: 3%;
    }

    .chapter .upload{
      width: 10%;
      float: right;
    }

    .chapter button{
      width: 85%;
      text-align: left;
      padding-left: 10%;
      padding-right: 10%;
    }

    .chapter .badge{
      float: right;
    }

    .section button{
      width: 85%;
      margin-left: 15%;
      text-align: left;
    }

    .section li{
      margin: 1% 0;
    }

    .sorts .second .current{
      color: violet;
    }

    .main-mbd{
      overflow: auto;
    }

    #article{
      width: 100%;
      background-color: black;
      color: white;
      position: absolute;
      left: 0;
      top: 0;
      padding:10% 5%;
      overflow: auto;
    }

    #article .quit-article{
      position: fixed;
      right: 5%;
      top: 3%;
      width: 15%;
    }

    #article .up-article{
      position: fixed;
      right: 5%;
      bottom: 3%;
      width: 15%;
      display: none;
    }

  </style>
</head>

<body>
  <div class="aslid-mbd">
    <div class="home-mbd"><a href="./index.html">HOME</a></div>
    <div class="hp">
      <div class="pic"><img src="./images/hp/ye2k.jpg" alt=""></div>
      <div class="currentname">ye2k</div>
    </div>
    <div class="sorts">
      <ul class="first">
        <li value="Common"><i class="glyphicon glyphicon-star" style="color:rgb(240, 28, 28)"></i> 通用
          <ul class="second"></ul>
        </li>
        <li value="BackEnd"><i class="glyphicon glyphicon-star" style="color:skyblue"></i> 后端
          <ul class="second">
          </ul>
        </li>
        <li value="FrontEnd"><i class="glyphicon glyphicon-star" style="color:lime"></i> 前端
          <ul class="second">
          </ul>
        </li>
        <li value="" class="clean"><i class="glyphicon glyphicon-star" style="color:violet"></i> 收起
          <ul class="second">
          </ul>
        </li>
      </ul>
    </div>
  </div>
  <div class="main-mbd">
    <div class="showMbdMain">
      <button bid="" type="button" class="btn btn-success btn-md btn-add-chapter hidden" data-toggle="modal"
        data-target="#addChapterBtn">
        新增
      </button>
      <button cid="" type="button" class="btn btn-warning btn-md btn-add-section hidden" data-toggle="modal"
        data-target="#addSectionBtn">
        新增
      </button>
      <!-- Modal -->
      <form id="chapterform">
        <div class="form-group modal fade" id="addChapterBtn" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="form-group modal-dialog" role="document">
            <div class="form-group modal-content">
              <div class="form-group modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">new Chapter</h4>
              </div>

              <div class="form-group modal-body">
                ChapterName: <input type="text" class="newChapter" name="chapterNameForm">
              </div>
              <div class="form-group modal-footer">
                <button type="button" class="btn btn-default close-modal-addChapter" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary save-addChapter">Save</button>
              </div>

            </div>
          </div>
        </div>
      </form>
      <div class="form-group modal fade" id="addSectionBtn" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="form-group modal-dialog" role="document">
          <div class="form-group modal-content">
            <div class="form-group modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="myModalLabel">new Chapter</h4>
            </div>
            <form id="sectionform">
              <div class="form-group modal-body">
                SectionName: <input type="text" class="newSection" style="margin-bottom:3px" name="sectionNameForm">
                <br>
                url: <label class="btn btn-default" for="newSection">上传文件</label>
                <input type="file" id="newSection" class="newSectionUrl hidden" style="float:right">
              </div>
              <div class="form-group modal-footer">
                <button type="button" class="btn btn-default close-modal-addSection" data-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary save-addSection">Save</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <ul class="main-mbd-ul">

      </ul>
    </div>
  </div>

  <div id="article" style="display:none">
    <button class="btn btn-warning quit-article">
      back
    </button>
    <button class="btn btn-success up-article">
      up
    </button>
    <div class="article-entry"></div>
  </div>

  <script src="./js/jquery/jquery-1.12.4.min.js"></script>
  <script src="./js/bootstrap/bootstrap.min.js"></script>
  <script src="./js/template-web.js"></script>
  <script src="https://cdn.bootcss.com/showdown/1.3.0/showdown.min.js"></script>
  <script src="./lib/bootstrap-validator/js/bootstrapValidator.min.js"></script>
  <script src="./js/css-js.js"></script>
  <script type="text/html" id="tpl">
      {{each data v i}}
      <li class="book" bid="{{v.bid}}">{{v.bookName}}</li>
      {{/each}}
  </script>

  <script type="text/html" id="tp-main">
    {{each data v i}}
    <li>
      <div class="chapter" cid="{{v.cid}}">
        <button class="btn btn-primary" type="button" >
          <i class="glyphicon glyphicon-leaf"></i><span class="chapterName"> {{v.chapterName}} </span><span class="badge upload">{{v.containSections}}</span>

        </button>
      </div>
      <ul class="section" cid="{{v.cid}}" style="display:none">

      </ul>
    </li>
    {{/each}}
  </script>

  <script type="text/html" id="tp-section">
    {{each data v i}}
    <li class="sectionDetial"  sid="{{v.sid}}">
        <button class="btn btn-success" type="button">
          {{v.sectionName}}
        </button>
      </li>
      {{/each}}
  </script>
  <script>

    $(function () {
      // 拼接url
      var purl = ["/md"]



      $(function () {
        $(".sorts .first>li").on("click", function () {
          var data = $(this).attr("value")
          $.ajax({
            url: "/myBookcase/showBooks",
            type: "get",
            data: {
              type: data,
            },
            dataType: "json",
            success: function (resultInfo) {
              if (resultInfo.flag) {
                var html = template("tpl", resultInfo)
                $(this).children(".second").html(html)
              } else {
                console.log(resultInfo.errMessage);
              }
            }.bind($(this)),
            complete: function () {
              $(this).find(".second li").slideToggle(500);
              $(this).siblings().find(".second li").slideUp(500);
            }.bind($(this))
          })
        })



        $(".sorts .second").on("click", "li", function (e) {
          e.stopPropagation()
          $(this).addClass("btn-warning")
          $(this).siblings().removeClass("btn-warning")
          $(".btn-add-chapter").attr("bid", $(this).attr("bid"))
          chapterRender($(this))
          purl[2] = $(this).text().replace(new RegExp(" ", "g"), "")
          $(".showMbdMain").css("display", "block")

        })
      })

      // 根据book渲染Chapter
      var chapterRender = function (ele) {
        // 先让新增按钮显示
        $(".btn-add-chapter").removeClass("hidden")
        var bid = ele.attr("bid")
        $.ajax({
          type: "get",
          dataType: "json",
          data: {
            bid: bid
          },
          url: "/myBookcase/showChapter",
          success: function (info) {
            if (info.flag) {
              $(".main-mbd-ul").html(template("tp-main", info))
            } else {
              console.log("服务器繁忙...");
            }
          }
        })
      }

      // 根据Chapter渲染Section
      var sectionRender = function (ele) {

        var cid = ele.attr("cid")
        $.ajax({
          type: "get",
          dataType: "json",
          data: {
            cid: cid
          },
          url: "/myBookcase/showSection",
          success: function (info) {
            if (info.flag) {
              ele.parent().children(".section").html(template("tp-section", info))
            } else {
              console.log("error");
            }
          }
        })
      }

      // 点击Chapter,显示对应的Section
      $(".main-mbd-ul").on("click", ".chapter", function () {
        sectionRender($(this))
        var index = $(this).parent().index()
        console.log(index);
        $(".main-mbd-ul .section").eq(index).toggle();
        if ($(".main-mbd-ul .section").eq(index).css("display") == "block") {
          $(".btn-add-section").removeClass("hidden")
          $(".btn-add-section").attr("cid", $(this).attr("cid"))
        } else {
          $(".btn-add-section").addClass("hidden")
          $(".btn-add-section").attr("cid", $(this).attr("cid"))
        }
        purl[3] = $(this).find("button .chapterName").text().replace(new RegExp(" ", "g"), "")
        console.log(purl);
      })


      // section点击事件
      $(".main-mbd-ul").on("click", ".sectionDetial", function (e) {
        e.stopPropagation()
        // 这里负责显示md
        $("#article").show();
        $(".main-mbd-ul").hide()
        var sid = $(this).attr("sid")
        $.ajax({
          type: "get",
          dataType: "json",
          data: {
            sid: sid
          },
          url: "/myBookcase/findMdUrlBySid",
          success: function (info) {
            var arr = info.data.split(".")
            var u = arr[arr.length - 1]
            // 要求获取的文件的后缀名必须是以.md结尾的
            if (u == "md") {
              renderMD(info.data)
            } else {
              $("#article .article-entry").html("获取的md文件有误")
              console.log("获取的md文件有误");
            }
          }
        })
      })

      $(".quit-article").on("click", function () {
        $("#article").hide();
        $(".main-mbd-ul").show()
        $(window).scrollTop("0")
      })

      function renderMD(path) {
        $.ajax({
          url: path,
          headers: {
            "content-type": "text/plain"
          },
          type: "get",
          success: function (info) {
            let Convertor = new showdown.Converter();
            let html = Convertor.makeHtml(info);
            $("#article .article-entry").html(html)//添加到 div 中 显示出来
          }
        })
      }

      $(".up-article").on("click", function () {
        $("#article").animate({
          scrollTop: 0,
        }, 500)
      })

      $("#article").scroll(function () {
        if ($(this).scrollTop() > 500) {
          $(".up-article").fadeIn(1000)

        } else {
          $(".up-article").fadeOut(1000)
        }
      })

      // 上传的文件
      var file

      $(".newSectionUrl").on("change", function () {
        file = this.files[0]
        console.log(file);
      })



      $("#sectionform").on("success.form.bv", function (e) {
        e.preventDefault()
        if ($(".newSection").val().trim().length == 0) {
          validatorsection.updateStatus("sectionNameForm", "INVALID", "notEmpty")
        } else {
          $(".save-addChapter").prop("disabled", "false")
        }

        var cid = $(".btn-add-section").attr("cid")
        var arr = $(".newSectionUrl").val().split("\\");
        purl[4] = arr[arr.length - 1].replace(new RegExp(" ", "g"), "")
        var mdurl = purl.join("/");
        console.log(mdurl);
        console.log(purl[4]);
        var formData = new FormData()
        console.log(cid);
        // formData.append("cid", cid)
        // formData.append("sectionName", $(".newSection").val())
        // formData.append("mdurl", mdurl)
        // formData.append("createTime", newDate)
        // formData.append("file", file)
        var date = new Date()
        var newDate = date.toLocaleString("chinese", { hour12: false })
        console.log(newDate);
        $.ajax({
          type: "post",
          dataType: "json",
          url: "/myBookcase/addSection",
          data: {
            cid: cid,
            sectionName: $(".newSection").val(),
            mdurl: mdurl,
            createTime: newDate
          },
          // processData: false,   // jQuery不要去处理发送的数据
          // contentType: false,
          success: function (info) {
            if (info) {
              console.log("ul");
              console.log(info);
            } else {
              console.log("err");
              console.log(info);
            }
          },
          complete: function () {
            $(".close-modal-addSection").trigger("click")
            $(".chapter[cid=" + cid + "]").trigger("click")
            $(".chapter[cid=" + cid + "]").trigger("click")
            validatorsection.resetForm(true)
          }
        })

        var formData = new FormData()
        formData.append("file", file)
        var dir = []
        for (var i = 0; i < purl.length - 1; i++) {
          dir.push(purl[i]);
        }
        var path = dir.join("/")
        formData.append("mdurl", mdurl)
        formData.append("dir", path)

        console.log(mdurl);
        $.ajax({
          type: "post",
          dataType: "json",
          url: "/myBookcase/addSectionFile",
          data: formData,
          processData: false,   // jQuery不要去处理发送的数据
          contentType: false,
          success: function (info) {
            if (info) {
              console.log("ul");
              console.log(info);
            } else {
              console.log("err");
              console.log(info);
            }
          },
        })
      })

      $(".save-addSection").on("click", function () {

      })


      $(".first li").on("click", function () {
        purl[1] = $(this).attr("value").replace(new RegExp(" ", "g"), "")
      })

      // 点击收起时清空show div
      $(".clean").on("click", function () {
        $(".showMbdMain").css("display", "none")
      })

      // 添加校验
      $("#chapterform").bootstrapValidator({
        feedbackIcons: {
          valid: 'glyphicon glyphicon-ok',
          invalid: 'glyphicon glyphicon-remove',
          validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
          chapterNameForm: {
            validators: {
              notEmpty: {
                message: "chapterName不能为空"
              }
            }
          }
        }
      })

      $("#sectionform").bootstrapValidator({
        feedbackIcons: {
          valid: 'glyphicon glyphicon-ok',
          invalid: 'glyphicon glyphicon-remove',
          validating: 'glyphicon glyphicon-refresh'
        },
        fields: {
          sectionNameForm: {
            validators: {
              notEmpty: {
                message: "sectionNameForm不能为空"
              }
            }
          }
        }
      })

      var validator = $("#chapterform").data('bootstrapValidator')
      var validatorsection = $("#sectionform").data('bootstrapValidator')

      $("#chapterform").on("success.form.bv", function (e) {
        e.preventDefault()
        console.log("hi");
        if ($(".newChapter").val().trim().length == 0) {
          validator.updateStatus("chapterNameForm", "INVALID", "notEmpty")
        } else {
          $(".save-addChapter").prop("disabled", "false")
        }

        // 这波操作...
        var sbt = function () {
          var date = new Date()
          var newDate = date.toLocaleString("chinese", { hour12: false })
          console.log(newDate);
          var bid = $(".btn-add-chapter").attr("bid")
          var chapterName = $(".main-mbd .newChapter").val()
          $.ajax({
            url: "/myBookcase/addChapterToBook",
            type: "post",
            data: {
              bid: bid,
              chapterName: chapterName,
              createTime: newDate
            },
            dataType: "json",
            success: function (resultInfo) {
              if (resultInfo.flag) {
                console.log("新增成功");
                $(".main-mbd .newChapter").val("")
                $(".close-modal-addChapter").trigger("click")
                $(".sorts .second li[bid=" + bid + "]").trigger("click")

              } else {
                console.log("新增失败");
              }
            },
            complete: function () {
              validator.resetForm(true)
            }
          })
        }
        sbt();
      })

    })
  </script>
</body>

</html>